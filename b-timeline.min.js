/*!
 * b-timeline v0.0.1, https://github.com/hoho/b-timeline
 * Copyright 2013 Marat Abdullin
 * Released under the MIT license
 */(function(e,t,n){"use strict";var r,i=function(e){return typeof e=="undefined"},s=function(e){return typeof e=="function"},o=Math.floor,u=Math.ceil,a=Math.round,f=Math.abs,l=864e5,c=[{left:"0",label:"00:00"},{left:"12.5%",label:"03:00"},{left:"25%",label:"06:00"},{left:"37.5%",label:"09:00"},{left:"50%",label:"12:00"},{left:"62.5%",label:"15:00"},{left:"75%",label:"18:00"},{left:"87.5%",label:"21:00"}],h=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],p="b-timeline",d=function(e,t){var n=e.style,r,i;for(r in t){i=t[r];try{n[r]=i+(typeof i=="number"?"px":"")}catch(s){}}},v=function(e,t){typeof e!="string"&&(t=e,e=n);var r=p+(e?"__"+e:""),i=[r],s;for(s in t)i.push(r+"_"+s+(t[s]===!0?"":"_"+t[s]));return i.join(" ")},m=function(e,t,n){return t=t||{},t["class"]=v(e,n),t},g=function(n,r){var s,o=function(t){var n=0,o;t||(t=e.event),t.wheelDelta&&(n=t.wheelDelta*-1),t.detail&&(n=t.detail),t.deltaX&&n==0&&(n=t.deltaX),t.deltaY&&n==0&&(n=t.deltaY),t.wheelDeltaX&&n==0&&(n=t.wheelDeltaX),t.wheelDeltaY&&n==0&&(n=t.wheelDeltaY),o=f(n);if(i(s)||o<s)s=o;return r(n/(s||1)),t.preventDefault&&t.preventDefault(),t.returnValue=!1};if(n.addEventListener){var u="onwheel"in t||t.documentMode>=9?["wheel"]:["mousewheel","DomMouseScroll","MozMousePixelScroll"],a;for(a=0;a<u.length;a++)n.addEventListener(u[a],o,!1)}else n.onmousewheel=o},y=function(e,t){return function(){t.apply(e,arguments)}};r=e.Timeline=function(p,b){var w=this,E={minTime:0,maxTime:0,now:n,autoUpdate:!1,viewport:1,minViewport:n,maxViewport:n,preloadBefore:1,preloadAfter:1,scrollViewport:.5,scrollPreloadBefore:1,scrollPreloadAfter:1},S,x,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W=function(s,l,c,h,p,y){var w=this,E,S,k=m("mark",{"data-index":function(e){return e}}),L={},A={},O,M,_,D,P,H,B,j,F,I,q,R,z,W,X,V,$,J=function(e,t){w.push(e,t,[])},K=function(e,t){var n=A[e],r;n&&(delete A[e],n.timeframe&&(r=L[n.timeframe],delete r.events[e],delete r.unfinished[e],t||(r.eventsElem.removeChild(n.elem1),r.eventsElem.removeChild(n.elem2))))},Q=function(e){if(i(L[e])){var t=L[e]={events:{},unfinished:{}},n=W(e),r=W(e+1);$C(s).div(m("timeframe")).act(function(){t.elem=this}).each(V(n,r)).div(m("tick",{style:{left:function(e,t){return t.left}}})).span().text(function(e,t){return t.label}).end(3).div(m("events-wrapper")).div(m("events")).act(function(){t.eventsElem=this}).div(m("future-overlay")).act(function(){t.futureElem=this}).end(5)}},G=function(e,t){var r=L[e],i,o;if(r){for(i in r.events)o=A[i],o.timeframe=n,t.push(o),delete A[i];s.removeChild(r.elem),delete L[e]}},Y=function(){return i(_)&&(_=s.clientWidth),u(_*(1/B))},Z=function(e){if(e.length){var t,r,s,o,u,f;for(t=0;t<e.length;t++){s=e[t],o=X(s.begin),u=s.begin===s.end?o:X(i(s.end)?N:s.end);if(u<O||o>=M)continue;r=a((o+u)/2),s.timeframe=f=r<O?O:r>=M?M-1:r,f=L[f],s.tbegin=o,s.tend=u,f.events[s.id]=!0,i(s.end)&&(f.unfinished[s.id]=!0),A[s.id]=s,r=f.eventsElem,s.elem1?(r.appendChild(s.elem1),r.appendChild(s.elem2)):$C(r).div(s.color?{style:{"background-color":s.color}}:n).act(function(){s.elem1=this}).end().div({"data-id":s.id,title:s.title}).act(function(){s.elem2=this}).each(s.marks).span(k).end(2).text(s.title).end(2),r=n,s.begin===s.end&&(r={type:"point"}),s.elem2.className=v("event-overlay",r),i(s.end)&&(r={type:"unfinished"}),s.elem1.className=v("event",r),s.positioned=!1}nt()}},et=function(){return-(F-O)*Y()},tt=function(){var e=Y(),t,n=a(et()),r,s,o,u;i(C)||(s=W(O));for(t=O;t<M;t++)r=L[t],d(r.elem,{left:n,width:e}),n+=e,i(C)||(o=W(t+1),u={},C>=o?u.display="none":(u.display="",u.left=s>=C?0:a(e*(C-s)/(o-s))),d(r.futureElem,u),s=o);C!==z&&(z=C,rt())},nt=function(e){var t,s,o,f,l,c,h,p=[],v,m=Y(),g,y,b={},w=r.EVENT_HSPACING/m,E=r.LETTER_WIDTH/m,S,x;for(t in A){o=A[t],p.push({begin:!0,event:o,sort:o.tbegin});if(!i(o.end)){if(e||i(o.tend2))o.tend2=o.tbegin+o.title.length*E+w,o.tend2-o.tend<w&&(o.tend2=o.tend+w);p.push({begin:!1,event:o,sort:o.tend2})}}p.sort(function(e,t){return e.sort<t.sort?-1:e.sort>t.sort?1:0}),v=-1;for(t=0;t<p.length;t++)f=p[t],o=f.event,o[f.begin?"i":"i2"]=t,o.positioned&&(v=t);for(t=0;t<p.length;t++){f=p[t],o=f.event;if(f.begin){if(o.positioned&&i(b[o.row]))b[s=o.row]=!0;else{x={};if(!e&&t<v&&!o.positioned)for(s=t+1;s<o.i2;s++)i(S=p[s].event.row)||(x[S]=!0);s=0;while(b[s]||x[s])s++;b[o.row=s]=!0}if(e||!o.positioned){g=a((o.tbegin-o.timeframe)*m),y=u(s/2)*(r.EVENT_HEIGHT+r.EVENT_VSPACING)*(s%2===0?1:-1),d(o.elem1,{left:g,top:y,width:o.begin===o.end?"":a((o.tend-o.tbegin)*m)||1}),s=0,h=0,l=o.elem2.firstChild;while(s<o.marks.length)c=a((X(o.marks[s])-o.timeframe)*m)-g,d(l,{left:h,width:c-h}),h=c,s++,l=l.nextSibling;d(o.elem2,{left:g,top:y,width:a((o.tend2-o.tbegin)*m)}),o.left=g,o.positioned=!0}}else b[o.row]=n}rt()},rt=function(){if(!i(C)){var e,t,n,r=Y(),s,o,u;s=X(C),s>=M&&(s=M),o=a((s-O)*r);for(e=O;e<M;e++){n=L[e].unfinished;for(t in n)u=A[t],d(u.elem1,{width:o-u.left}),d(u.elem2,{width:o-u.left});o-=r}}},it=function(){var e,t;e=O,t=M-1;while(e<M&&!i(L[e].loading))e++;while(t>=O&&!i(L[t].loading))t--;if(e<=t)return{timeframeFrom:e,timeframeTo:t+1,timeFrom:W(e),timeTo:W(t+1)}};w.getPosition=function(){return j},w.setPosition=function(t,r,s,a){if(!i(r)){var l=w.getX(j),c=f(j-r),h=j>r?-3:3,p=f(j-w.byX(l+h));c<p?(t=r,r=n):t=j+c/h}var d,v,m,g,b,E,S,T=[],C;D=B,I=r,q=s,R=a,d=j,F=X(t<x?x:t>N?N:t)-B/2,F>(t=X(N)-B)&&(F=t),F<(t=X(x))&&(F=t),j=W(F+B/2),j>N&&(j=N),t=F,v=W(o(t-P)),m=W(u(t+B+H)),v<x&&(v=x),m>N&&(m=N),g=o(X(v)),b=u(X(m));for(E=g;E<b;E++)Q(E);if(!i(O)){for(E=O;E<g;E++)G(E,T);for(E=b;E<M;E++)G(E,T)}O=g,M=b,tt(),Z(T);if(S=it())$&&e.clearTimeout($),C=function(){$=n,v=S.timeFrom,m=S.timeTo,w.status(v,m,!0,!1),J(v,m)},i(r)?C():$=e.setTimeout(C,55);return!i(r)&&j!==d&&e.requestAnimationFrame(function(){i(I)||w.setPosition(n,I,q,R)}),s&&s(j,d),!a&&y&&y(j,d),j},w.status=function(t,n,r,i){var s=o(X(t)),u=o(X(n)),a,f;for(f=s;f<u;f++)if(a=L[f]){if(!r||i)a.loading&&(function(t){e.setTimeout(function(){t.className=v("timeframe")},0)}(a.elem),a.loading=!1),i&&(a.error=!0);r&&(a.elem.className=v("timeframe",{loading:!0}),a.loading=!0),i||(a.error=!1)}if(!i)for(f=O;f<M;f++)if(L[f].error)return!0;return i},w.events=function(e){J=e},w.timing=function(e,t,n){W=e,X=t,V=n},w.bounds=function(e,t,n){B=e,P=t,H=n},w.push=function(e,t,n){var r,s,o,u=[];for(r=0;r<n.length;r++){s=n[r];if(i(s.begin)&&i(s.end))continue;o={id:s.id,data:s.data,title:s.title?s.title+"":"",begin:i(s.begin)?s.end:s.begin,end:s.end,marks:Array.prototype.slice.call(s.marks||[],0),color:s.color,positioned:!1};if(s=A[o.id]){s.data=o.data;if(s.title===o.title&&s.begin===o.begin&&s.end===o.end&&s.color===o.color&&s.marks.length===o.marks.length)continue;K(o.id,!0),o.row=s.row,o.elem1=s.elem1,d(o.elem1,{"background-color":o.color||""}),(s.title!==o.title||o.marks.length!==s.marks.length)&&$C(o.elem2,!0).each(o.marks).span(k).end(2).text(o.title).end(),o.elem2=s.elem2}o.marks.sort(),u.push(o)}return Z(u),w.status(e,t,!1,!1)},w.update=function(e){var t=W(O),n=W(M);w.setPosition(j),e&&w.status(t,n,!0,!1),J(t,n)},w.getX=function(e){return a((X(e)-O)*Y()+et()+10)},w.byX=function(e){var t=Y();return W((e+O*t-et()-10)/t)},w.resize=function(){if(s.clientWidth!==_||D!==B)_=n,w.setPosition(j),nt(!0)},b(s,"mousedown",function(e){E=e.pageX}),b(s,"mousemove",function(e){!i(E)&&!i(B)&&e.pageX!==E&&(w.setPosition(W(X(j)+(E-e.pageX)/Y())),E=e.pageX,S=!0)}),b(s,"mouseup",function(e){if(!S&&p){var t=e.target,n=t.className||"",r,i,o,u,f,l=s,c=e.pageX-a(et())-1;while(l)c-=l.offsetLeft,l=l.offsetParent;n.indexOf(v("event-overlay"))>=0?r="event":n.indexOf(v("mark"))>=0&&(r="mark");switch(r){case"mark":i=t.parentNode,u=t.getAttribute("data-index");case"event":o=(i||t).getAttribute("data-id"),o&&U&&(f=A[o],r==="event"&&f.marks.length&&(u=f.marks.length))}p(e,W(c/Y()+O),o,u,(A[o]||{}).data)}}),b(t,"mouseup",function(e){E=S=n}),b(l,"click",function(){w.setPosition(n,W(X(j)-B*.4))}),b(c,"click",function(){w.setPosition(n,W(X(j)+B*.4))}),g(s,function(e){i(x)||w.setPosition(W(X(j)+B*e*.002))}),h&&b(t,"keydown",function(e){var t;switch(e.which){case 37:t=-1;break;case 39:t=1}t&&w.setPosition(W(X(j)+t*B*(e.shiftKey?.4:.05)))})},X=function(){var e,t;S={};for(e in E)S[e]=s(t=E[e])?t():t;x=S.minTime,N=S.maxTime,C=S.now,k=S.autoUpdate,t=new Date(x),A=(new Date(t.getFullYear(),t.getMonth(),t.getDate())).getTime(),P.bounds(S.viewport,S.preloadBefore,S.preloadAfter),j.bounds(S.scrollViewport,S.scrollPreloadBefore,S.scrollPreloadAfter)},V=function(){L&&(e.clearTimeout(L),L=n),k>0&&(L=e.setTimeout(function(){L=n,X(),P.update()},k))};w.bounds=function(e){if(!i(e)){var t,n;for(t in E)i(n=e[t])||(E[t]=n)}return X(),d(D,{display:i(S.minViewport)||i(S.maxViewport)?"none":"block"}),w},w.events=function(e){return P.events(y(w,e)),w},w.timing=function(e,t,n){return P.timing(e,t,n),w},w.position=function(e){return i(e)?P.getPosition():(X(),P.setPosition(e),w)},w.push=function(e,t,n){return q=P.push(e,t,n),q||d(M,{display:"none"}),V(),w},w.error=function(e,t,n){return d(M,{display:"block"}),$C(M.firstChild,!0).text(n).end(),q=P.status(e,t,!1,!0),V(),w},w.click=function(e){return U=e,w},w.resize=function(){return X(),P.resize(),j.resize(),w};var $=function(){var e=this;b(e,"click",function(){if(S){var t=S.viewport,n=S.minViewport,r=S.maxViewport;!i(n)&&!i(r)&&(t+=.1*(e.className.indexOf("zoom-in")>0?-1:1),t<n&&(t=n),t>r&&(t=r),w.bounds({viewport:t}),w.resize())}})};$C(p,!0).div(m()).act(function(){O=this}).div(m("error-wrapper")).act(function(){M=this}).span(m("error")).end(2).div(m("scaler")).act(function(){D=this}).div(m("scaler-button",n,{"zoom-out":!0})).act($).end().div(m("scaler-button",n,{"zoom-in":!0})).act($).end().div(m("scaler-ruler")).end(2).div(m("left")).act(function(){H=this}).div().end(2).div(m("right")).act(function(){B=this}).div().end(2).div(m("timeframes")).act(function(){P=new W(this,H,B,!0,function(e,t,n,r,s){!i(n)&&U&&U(e,n,r,s)},function(e,t){j.setPosition(i(t)?e:j.getPosition()+(e-t))})}).end().div(m("gap"),!0).div(m("pick")).act(function(){_=this}).end().div(m("left",n,{scrollbar:!0})).act(function(){F=this}).div().end(2).div(m("right",n,{scrollbar:!0})).act(function(){I=this}).div().end(2).div(m("scrollbar")).act(function(){j=new W(this,F,I,n,function(e,t){P.setPosition(n,t,function(e){d(_,{left:j.getX(e)-7})},!0)},function(){d(_,{left:a(j.getX(P.getPosition()))-7})})}).end(3),b(M,"click",function(){P.update(!0)}),P.timing(function(e){return e*l+A%l},function(e){return(e-A%l)/l},function(e,t){var n=new Date(e);return c[0].label=h[n.getMonth()]+" "+n.getDate()+" "+n.getFullYear(),c}),j.timing(function(e){var t=(new Date(o(e),0,1)).getTime(),n=(new Date(o(e)+1,0,1)).getTime();return t+(n-t)*(e-o(e))},function(e){var t=(new Date(e)).getFullYear(),n=new Date(t,0,1),r=new Date(t+1,0,1);return t+(e-n)/(r-n)},function(e,t){var n=new Date(e),r,i=[];for(r=0;r<12;r++)n.setMonth(r),i.push({left:100*(n.getTime()-e)/(t-e)+"%",label:h[n.getMonth()]+(r%3===0?", "+n.getFullYear():"")});return i}),b(e,"resize",function(){z&&e.clearTimeout(z),z=e.setTimeout(function(){z=n,w.resize()},100)})},r.EVENT_HEIGHT=30,r.EVENT_HSPACING=30,r.EVENT_VSPACING=5,r.LETTER_WIDTH=7.5})(window,document);